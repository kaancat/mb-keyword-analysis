<!--
NMD Law Group - GHL Form Tracking Snippet (v5)
===============================================
BULLETPROOF APPROACH: Uses image pixel to send GCLID to n8n.
Image requests bypass all CORS restrictions - browsers always allow them.

ADD THIS TO YOUR GHL FORM via the "HTML" element feature.
-->

<!-- Google Tag for GA4 + Google Ads -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GMJZFFYVF7"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'G-GMJZFFYVF7');
  gtag('config', 'AW-7562650658');
</script>

<!-- Facebook Pixel -->
<script>
  !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
  n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
  document,'script','https://connect.facebook.net/en_US/fbevents.js');
  fbq('init', '1642362299753454');
</script>

<!-- GCLID Capture & Image Pixel Script (v5) -->
<script>
(function() {
  'use strict';

  var DEBUG = true;
  var GCLID_KEY = '_nmd_gclid';
  var FBCLID_KEY = '_nmd_fbclid';

  // n8n webhook URL for GCLID enrichment (uses existing POST endpoint)
  var N8N_GCLID_WEBHOOK = 'https://phpstack-1370137-5762452.cloudwaysapps.com/webhook/nmd-form-submission';

  function log(msg, data) {
    if (DEBUG) console.log('[NMD v5]', msg, data || '');
  }

  // ============================================
  // Storage Functions
  // ============================================

  function getGclid() {
    try {
      var stored = localStorage.getItem(GCLID_KEY);
      if (stored) return stored;
    } catch(e) {}

    try {
      var params = new URLSearchParams(window.location.search);
      var urlGclid = params.get('gclid');
      if (urlGclid) {
        localStorage.setItem(GCLID_KEY, urlGclid);
        return urlGclid;
      }
    } catch(e) {}

    return null;
  }

  function getFbclid() {
    try {
      var stored = localStorage.getItem(FBCLID_KEY);
      if (stored) return stored;

      var params = new URLSearchParams(window.location.search);
      var urlFbclid = params.get('fbclid');
      if (urlFbclid) {
        localStorage.setItem(FBCLID_KEY, urlFbclid);
        return urlFbclid;
      }
    } catch(e) {}
    return null;
  }

  function storeGclid(gclid) {
    if (!gclid) return;
    try {
      localStorage.setItem(GCLID_KEY, gclid);
      log('Stored GCLID:', gclid);
    } catch(e) {}
  }

  function storeFbclid(fbclid) {
    if (!fbclid) return;
    try {
      localStorage.setItem(FBCLID_KEY, fbclid);
      log('Stored FBCLID:', fbclid);
    } catch(e) {}
  }

  // ============================================
  // Parent Window Communication
  // ============================================

  window.addEventListener('message', function(event) {
    if (event.data && event.data.type === 'GCLID_VALUE') {
      if (event.data.gclid) {
        storeGclid(event.data.gclid);
        log('Received GCLID from parent:', event.data.gclid);
      }
      if (event.data.fbclid) {
        storeFbclid(event.data.fbclid);
        log('Received FBCLID from parent:', event.data.fbclid);
      }
    }
  });

  // ============================================
  // Form Data Extraction
  // ============================================

  function getFormData() {
    var data = {
      email: '',
      phone: '',
      firstName: '',
      lastName: ''
    };

    // Try to find form fields
    var inputs = document.querySelectorAll('input, textarea');
    inputs.forEach(function(input) {
      var name = (input.name || input.placeholder || '').toLowerCase();
      var value = input.value || '';

      if (name.indexOf('email') > -1 || input.type === 'email') {
        data.email = value;
      } else if (name.indexOf('phone') > -1 || name.indexOf('telefon') > -1 || input.type === 'tel') {
        data.phone = value;
      } else if (name.indexOf('first') > -1 || name.indexOf('navn') > -1 || name.indexOf('fulde') > -1) {
        if (!data.firstName) data.firstName = value;
      } else if (name.indexOf('last') > -1 || name.indexOf('efter') > -1) {
        data.lastName = value;
      }
    });

    return data;
  }

  // ============================================
  // Send GCLID to n8n (POST with sendBeacon)
  // ============================================

  function sendGclidToN8n(formData) {
    var gclid = getGclid();
    var fbclid = getFbclid();

    if (!gclid && !fbclid) {
      log('No GCLID or FBCLID to send');
      return;
    }

    // Build payload for POST request
    var payload = {
      gclid: gclid || '',
      fbclid: fbclid || '',
      email: formData.email || '',
      phone: formData.phone || '',
      first_name: formData.firstName || '',
      last_name: formData.lastName || '',
      full_name: (formData.firstName + ' ' + formData.lastName).trim(),
      timestamp: new Date().toISOString(),
      source: 'ghl_form_v5_enrichment',
      type: 'gclid_enrichment'
    };

    log('Sending GCLID via POST:', payload);

    // Method 1: sendBeacon (most reliable - works even on page unload)
    if (navigator.sendBeacon) {
      try {
        var blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
        var sent = navigator.sendBeacon(N8N_GCLID_WEBHOOK, blob);
        log('Beacon sent:', sent ? 'success' : 'failed');
      } catch(e) {
        log('Beacon error:', e);
      }
    }

    // Method 2: Backup with fetch (for browsers that support it)
    try {
      fetch(N8N_GCLID_WEBHOOK, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        keepalive: true,
        mode: 'no-cors'
      }).then(function() {
        log('Fetch completed (GCLID sent!)');
      }).catch(function(e) {
        log('Fetch error (beacon likely succeeded):', e);
      });
    } catch(e) {
      log('Fetch not available:', e);
    }
  }

  // ============================================
  // Form Submit Tracking
  // ============================================

  var formTracked = false;

  function trackLead() {
    if (formTracked) return;
    formTracked = true;

    var gclid = getGclid();
    var formData = getFormData();

    log('Tracking lead with gclid:', gclid);
    log('Form data:', formData);

    // Send GCLID enrichment to n8n
    sendGclidToN8n(formData);

    // GA4 Event
    if (typeof gtag === 'function') {
      gtag('event', 'generate_lead', {
        event_category: 'form',
        event_label: 'contact_form',
        gclid: gclid || '',
        value: 500,
        currency: 'DKK'
      });
      log('Sent GA4 generate_lead event');
    }

    // Facebook Pixel
    if (typeof fbq === 'function') {
      fbq('track', 'Lead', {
        content_name: 'Contact Form',
        currency: 'DKK',
        value: 500
      });
      log('Sent FB Lead event');
    }

    // DataLayer for GTM
    if (typeof dataLayer !== 'undefined') {
      dataLayer.push({
        event: 'ghl_form_submit',
        gclid: gclid || '',
        timestamp: new Date().toISOString()
      });
    }
  }

  // Listen for form submit
  document.addEventListener('submit', function(e) {
    trackLead();
  }, true);

  // Watch for success message (GHL's way of showing form submitted)
  var observer = new MutationObserver(function(mutations) {
    for (var i = 0; i < mutations.length; i++) {
      var mutation = mutations[i];
      for (var j = 0; j < mutation.addedNodes.length; j++) {
        var node = mutation.addedNodes[j];
        if (node.nodeType === 1) {
          var text = (node.textContent || '').toLowerCase();
          if (text.indexOf('tak') > -1 || text.indexOf('thank') > -1 || text.indexOf('success') > -1) {
            trackLead();
            observer.disconnect();
            return;
          }
        }
      }
    }
  });

  // ============================================
  // Initialize
  // ============================================

  function init() {
    log('Initializing v5 (image pixel approach)...');

    // Request GCLID from parent (Wix) via postMessage
    try {
      window.top.postMessage({ type: 'REQUEST_GCLID' }, '*');
      log('Requested GCLID from parent');
    } catch(e) {
      try {
        window.parent.postMessage({ type: 'REQUEST_GCLID' }, '*');
      } catch(e2) {}
    }

    // Start observing for success message
    if (document.body) {
      observer.observe(document.body, { childList: true, subtree: true });
    }

    log('Initialized');
  }

  // Run when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

})();
</script>
